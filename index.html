<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Mastery | è‹±è¯­æ ¸å¿ƒè¯æ±‡</title>
    <style>
        :root {
            /* é…è‰²æ–¹æ¡ˆï¼šæŸ”å’ŒæŠ¤çœ¼ (Paper/Sage Theme) */
            --primary: #5e8b7e;       /* é¼ å°¾è‰ç»¿ */
            --primary-dark: #3a5a50;
            --accent: #d97757;        /* é™¶åœŸè‰²ï¼Œç”¨äºå¼ºè°ƒ */
            --bg-body: #f7f6f2;       /* ç±³ç™½çº¸å¼ è‰² */
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-light: #7f8c8d;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0,0,0,0.05);
            --radius: 12px;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- å¤´éƒ¨ --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px 0;
        }

        h1 {
            color: var(--primary-dark);
            margin: 0;
            font-size: 2.2rem;
            letter-spacing: -0.5px;
        }

        .subtitle {
            color: var(--text-light);
            margin-top: 10px;
            font-weight: 300;
        }

        /* --- æ§åˆ¶æ  --- */
        .controls-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            position: sticky;
            top: 20px;
            z-index: 100;
            border: 1px solid var(--border);
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: 0.2s;
            background: #fafafa;
        }

        .search-box:focus {
            border-color: var(--primary);
            background: #fff;
            outline: none;
        }

        select.search-box {
            flex: 0 0 auto;
            width: auto;
            cursor: pointer;
        }

        /* --- æŒ‰é’®æ ·å¼ --- */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.1s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn:active { transform: scale(0.98); }
        .btn:hover { opacity: 0.9; }

        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-light); }

        /* --- è¡¨æ ¼åŒºåŸŸ --- */
        .table-wrapper {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8fafc;
            text-align: left;
            padding: 18px;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid var(--border);
        }

        td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fcfb; }

        .word-text {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--primary-dark);
            display: block;
        }
        
        .phonetic-text {
            color: var(--text-light);
            font-size: 0.9rem;
            font-family: 'Lucida Sans Unicode', sans-serif;
        }

        .pos-badge {
            background: #edf2f7;
            color: #4a5568;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .speaker-icon {
            cursor: pointer;
            color: var(--primary);
            margin-left: 8px;
            vertical-align: middle;
            opacity: 0.6;
            transition: 0.2s;
        }
        .speaker-icon:hover { opacity: 1; transform: scale(1.1); }

        tr.marked {
            background-color: #f0fdf4;
            opacity: 0.6;
        }
        tr.marked .word-text { text-decoration: line-through; }

        .check-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--border);
            background: transparent;
            color: transparent;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .check-btn.active {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        /* --- åˆ†é¡µ --- */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 30px;
            color: var(--text-light);
        }

        /* --- å…¨å±è½¬ç›˜æ¨¡æ€æ¡† --- */
        .wheel-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: #2c3e50;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* è½¬ç›˜é¡¶éƒ¨æ§åˆ¶æ  */
        .wheel-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            color: white;
            pointer-events: none;
            z-index: 101;
        }
        .wheel-controls > * { pointer-events: auto; }

        .mode-switch {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 30px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .mode-btn {
            padding: 8px 18px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            background: transparent;
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        .mode-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .mode-btn.active {
            background: var(--accent);
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        /* è½¬ç›˜èˆå° - å°ºå¯¸ä¼˜åŒ– */
        .wheel-stage {
            position: relative;
            /* å¢å¤§å°ºå¯¸ï¼šä½¿ç”¨ min(95vw, 750px) ç¡®ä¿åœ¨å°å±ä¸Šæ’‘æ»¡ï¼Œåœ¨å¤§å±ä¸Šæ›´å¤§ */
            width: min(95vw, 750px);
            height: min(95vw, 750px);
            max-height: 85vh; /* é˜²æ­¢é«˜åº¦æº¢å‡ºå±å¹• */
            max-width: 85vh;  /* ä¿æŒæ­£æ–¹å½¢ */
            transition: transform 0.5s;
            margin-top: 20px;
        }

        canvas#wheelCanvas {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 20px 50px rgba(0,0,0,0.5));
        }

        .wheel-pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 60px;
            background: #e74c3c;
            clip-path: polygon(100% 0, 50% 100%, 0 0);
            z-index: 10;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.4));
        }

        .spin-trigger {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90px; height: 90px;
            border-radius: 50%;
            background: white;
            border: 5px solid var(--accent);
            color: var(--accent);
            font-weight: 900;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(0,0,0,0.3);
            z-index: 20;
            transition: 0.2s;
        }
        .spin-trigger:hover { transform: translate(-50%, -50%) scale(1.1); }
        .spin-trigger:disabled { background: #ccc; border-color: #999; color: #999; cursor: not-allowed; }

        /* ç­”é¢˜å¡ç‰‡ */
        .flashcard {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            width: min(90vw, 360px);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 25px 60px rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 50;
        }

        .flashcard.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }

        .card-question {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-dark);
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .card-hint {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .answer-mask {
            background: #f1f5f9;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            position: relative;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            transition: background 0.2s;
        }
        .answer-mask:hover { background: #e2e8f0; }

        .answer-content {
            opacity: 0;
            transition: 0.3s;
            filter: blur(8px);
        }
        
        .answer-mask.revealed .answer-content {
            opacity: 1;
            filter: blur(0);
        }

        .eye-icon {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.1rem;
            color: var(--text-light);
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .answer-mask.revealed .eye-icon { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }

        .card-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }
        
        .action-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
        }

        /* åº•éƒ¨ä¿¡æ¯ */
        .custom-add-area {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            padding: 10px 25px;
            border-radius: 30px;
            color: white;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            white-space: nowrap;
        }

        .close-wheel {
            font-size: 2.5rem;
            line-height: 1;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: 0.2s;
        }
        .close-wheel:hover { color: white; transform: rotate(90deg); }

        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            .wheel-stage { margin-top: 60px; }
            .controls-card { position: static; }
        }
    </style>
    <script src="./index.js"></script>
</head>
<body>

<div class="container">
    <header>
        <h1>English Core Vocabulary</h1>
        <div class="subtitle">é«˜æ•ˆè®°å¿† Â· çº¯æ­£å‘éŸ³ Â· æ¸¸æˆåŒ–å¤ä¹ </div>
    </header>

    <div class="controls-card">
        <input type="text" id="searchInput" class="search-box" placeholder="æœç´¢å•è¯ã€é‡Šä¹‰ (Search)...">
        
        <select id="pageSizeSelect" class="search-box">
            <option value="20">20 æ¡/é¡µ</option>
            <option value="50">50 æ¡/é¡µ</option>
            <option value="100">100 æ¡/é¡µ</option>
        </select>

        <label style="display:flex; alignItems:center; gap:8px; cursor:pointer; user-select:none;">
            <input type="checkbox" id="hideMarkedCheckbox">
            <span style="font-size:0.9rem; color:var(--text-light)">éšè—å·²æŒæ¡</span>
        </label>

        <div style="flex:1"></div>

        <button class="btn btn-accent" onclick="openWheel()">
            <span style="font-size:1.2rem">ğŸ¡</span> è¿›å…¥è¶…çº§è½¬ç›˜
        </button>
    </div>

    <div class="table-wrapper">
        <table id="vocabTable">
            <thead>
                <tr>
                    <th style="width: 80px; text-align:center;">çŠ¶æ€</th>
                    <th style="width: 25%">å•è¯ / éŸ³æ ‡</th>
                    <th style="width: 10%">è¯æ€§</th>
                    <th style="width: 25%">é‡Šä¹‰</th>
                    <th style="width: 40%">ä¾‹å¥</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="pagination">
        <button class="btn btn-outline" id="prevBtn" onclick="changePage(-1)">Previous</button>
        <span id="pageInfo">Page 1</span>
        <button class="btn btn-outline" id="nextBtn" onclick="changePage(1)">Next</button>
    </div>
</div>

<div id="wheelOverlay" class="wheel-overlay">
    
    <div class="wheel-controls">
        <div style="display:flex; gap:15px; align-items:center;">
            <div class="mode-switch">
                <button class="mode-btn active" onclick="setWheelMode('en_cn')" id="modeEnCn">è‹± âœ ä¸­</button>
                <button class="mode-btn" onclick="setWheelMode('cn_en')" id="modeCnEn">ä¸­ âœ è‹±</button>
            </div>
            <button class="btn btn-outline" style="color:white; border-color:rgba(255,255,255,0.4); padding:6px 15px; font-size:0.9rem;" onclick="refreshWheelRandomly()">
                ğŸ”„ æ¢ä¸€æ‰¹
            </button>
        </div>
        <div class="close-wheel" onclick="closeWheel()">&times;</div>
    </div>

    <div class="wheel-stage">
        <div class="wheel-pointer"></div>
        <canvas id="wheelCanvas" width="1000" height="1000"></canvas>
        <button id="spinBtn" class="spin-trigger" onclick="spinWheel()">SPIN</button>
    </div>

    <div id="flashcard" class="flashcard">
        <div style="text-align:right;">
             <span class="speaker-icon" style="font-size:1.5rem;" onclick="speakCurrentCard()">ğŸ”Š</span>
        </div>
        <div id="cardQuestion" class="card-question">Word</div>
        <div id="cardHint" class="card-hint">Hint</div>
        
        <div class="answer-mask" onclick="revealAnswer()">
            <div class="eye-icon"><span>ğŸ‘ï¸</span> <span>ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</span></div>
            <div id="cardAnswer" class="answer-content"></div>
        </div>

        <div class="card-actions">
            <button class="action-btn" style="background:#f1f5f9; color:#64748b;" onclick="cardAction('miss')">
                æ²¡è®°ä½
            </button>
            <button class="action-btn" style="background:var(--primary); color:white; box-shadow:0 4px 10px rgba(16,185,129,0.3);" onclick="cardAction('got')">
                è®°ä½äº† (ç§»é™¤)
            </button>
        </div>
    </div>

    <div class="custom-add-area">
        <span id="wheelStats">åŠ è½½ä¸­...</span>
    </div>
</div>

<script>
    // -------------------------------------------------------------------------
    // 1. æ•°æ®æº
    // -------------------------------------------------------------------------
    

    // -------------------------------------------------------------------------
    // 2. æ ¸å¿ƒé€»è¾‘å˜é‡
    // -------------------------------------------------------------------------
    let processedData = [];
    let filteredData = [];
    let markedWords = new Set(JSON.parse(localStorage.getItem('vocab_marked') || '[]'));
    
    let currentPage = 1;
    let itemsPerPage = 20;

    // è½¬ç›˜ç›¸å…³
    let wheelData = [];        
    let wheelEliminated = new Set(); 
    let wheelMode = 'en_cn';   
    let isSpinning = false;
    let currentCardIndex = -1; 

    // -------------------------------------------------------------------------
    // 3. åˆå§‹åŒ–ä¸äº‹ä»¶
    // -------------------------------------------------------------------------
    function init() {
        processData();
        applyFilters();

        document.getElementById('searchInput').addEventListener('input', () => { currentPage=1; applyFilters(); });
        document.getElementById('hideMarkedCheckbox').addEventListener('change', () => { currentPage=1; applyFilters(); });
        document.getElementById('pageSizeSelect').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        });
        
        // é¢„åŠ è½½è¯­éŸ³
        if('speechSynthesis' in window) window.speechSynthesis.getVoices();
    }

    function processData() {
        const map = new Map();
        rawData.forEach(item => {
            if(item.word) map.set(item.word.toLowerCase().trim(), item);
        });
        processedData = Array.from(map.values());
    }

    // -------------------------------------------------------------------------
    // 4. è¡¨æ ¼æ¸²æŸ“
    // -------------------------------------------------------------------------
    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase().trim();
        const hideMarked = document.getElementById('hideMarkedCheckbox').checked;

        filteredData = processedData.filter(item => {
            const key = item.word.toLowerCase();
            if (hideMarked && markedWords.has(key)) return false;
            if (search && !key.includes(search) && !item.meaning.includes(search)) return false;
            return true;
        });

        renderTable();
        updatePagination();
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        
        const start = (currentPage - 1) * itemsPerPage;
        const pageData = filteredData.slice(start, start + itemsPerPage);

        if(pageData.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:30px; color:#999;">æ— æ•°æ®</td></tr>`;
            return;
        }

        pageData.forEach(item => {
            const isMarked = markedWords.has(item.word.toLowerCase());
            const tr = document.createElement('tr');
            if (isMarked) tr.classList.add('marked');

            tr.innerHTML = `
                <td style="text-align:center;">
                    <button class="check-btn ${isMarked ? 'active' : ''}" 
                            onclick="toggleMark('${item.word.replace(/'/g, "\\'")}')">âœ“</button>
                </td>
                <td>
                    <span class="word-text">${item.word} 
                        <span class="speaker-icon" onclick="speak('${item.word.replace(/'/g, "\\'")}')">ğŸ”Š</span>
                    </span>
                    <div class="phonetic-text">${item.phonetic || ''}</div>
                </td>
                <td><span class="pos-badge">${item.pos || ''}</span></td>
                <td>${item.meaning}</td>
                <td style="color:#555; font-size:0.95rem;">
                    <div>${item.sentence || ''}</div>
                    <div style="color:#999; font-size:0.85rem;">${item.translation || ''}</div>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    window.toggleMark = function(word) {
        const key = word.toLowerCase();
        if (markedWords.has(key)) markedWords.delete(key);
        else markedWords.add(key);
        localStorage.setItem('vocab_marked', JSON.stringify(Array.from(markedWords)));
        applyFilters(); 
    }

    window.speak = function(text) {
        if (!window.speechSynthesis) return;
        window.speechSynthesis.cancel(); 
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'en-US'; 
        utterance.rate = 0.9;     
        window.speechSynthesis.speak(utterance);
    }

    window.changePage = function(delta) {
        const max = Math.ceil(filteredData.length / itemsPerPage) || 1;
        currentPage += delta;
        if(currentPage < 1) currentPage = 1;
        if(currentPage > max) currentPage = max;
        renderTable();
        updatePagination();
        window.scrollTo({top:0, behavior:'smooth'});
    }

    function updatePagination() {
        const max = Math.ceil(filteredData.length / itemsPerPage) || 1;
        document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${max}`;
        document.getElementById('prevBtn').disabled = (currentPage === 1);
        document.getElementById('nextBtn').disabled = (currentPage === max);
    }

    // -------------------------------------------------------------------------
    // 5. è¶…çº§è½¬ç›˜é€»è¾‘ (æ ¸å¿ƒä¿®æ”¹)
    // -------------------------------------------------------------------------
    
    window.openWheel = function() {
        document.getElementById('wheelOverlay').style.display = 'flex';
        // æ¯æ¬¡æ‰“å¼€å¦‚æœæ²¡æ•°æ®åˆ™åˆ·æ–°
        if (wheelData.length === 0) refreshWheelRandomly();
        else drawWheel();
    }

    window.closeWheel = function() {
        document.getElementById('wheelOverlay').style.display = 'none';
        document.getElementById('flashcard').classList.remove('show');
    }

    // åˆ‡æ¢æ¨¡å¼å¹¶åˆ·æ–°
    window.setWheelMode = function(mode) {
        if (wheelMode === mode) return; // ç›¸åŒåˆ™ä¸åˆ·æ–°
        wheelMode = mode;
        
        // UI æ›´æ–°
        document.getElementById('modeEnCn').classList.toggle('active', mode==='en_cn');
        document.getElementById('modeCnEn').classList.toggle('active', mode==='cn_en');
        
        // æ ¸å¿ƒï¼šåˆ‡æ¢æ¨¡å¼åï¼Œé‡æ–°åˆ·æ–°50ä¸ªè¯
        refreshWheelRandomly();
    }

    window.refreshWheelRandomly = function() {
        wheelEliminated.clear();
        // æ’é™¤å·²æŒæ¡çš„è¯
        const pool = processedData.filter(i => !markedWords.has(i.word.toLowerCase()));
        
        if (pool.length === 0) {
            alert("è¯åº“ä¸ºç©ºæˆ–æ‰€æœ‰å•è¯å·²æŒæ¡ï¼");
            return;
        }

        // æ´—ç‰Œ
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        
        // å–å‰50ä¸ª (å¦‚æœä¸è¶³50å°±å–å…¨éƒ¨)
        wheelData = pool.slice(0, 50);
        updateWheelStats();
        drawWheel(); // é‡ç»˜ï¼Œæ–‡å­—ä¼šæ ¹æ® wheelMode å˜åŒ–
    }

    function updateWheelStats() {
        const left = wheelData.length - wheelEliminated.size;
        const modeText = wheelMode === 'en_cn' ? "è‹± âœ ä¸­" : "ä¸­ âœ è‹±";
        document.getElementById('wheelStats').innerText = 
            `[${modeText}] æœ¬è½®åº“: ${wheelData.length} è¯ | å‰©ä½™æ´»è·ƒ: ${left}`;
    }

    function drawWheel() {
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const count = wheelData.length;
        const width = canvas.width;
        const center = width / 2;
        const radius = width / 2 - 40; // ç•™è¾¹è·
        const arc = (2 * Math.PI) / count;
        
        const colors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#95a5a6'];

        ctx.clearRect(0,0,width,width);

        ctx.font = "bold 24px Arial"; // è°ƒæ•´å­—ä½“å¤§å°é€‚åº”å¤§åˆ†è¾¨ç‡
        ctx.textBaseline = 'middle';

        for(let i=0; i<count; i++) {
            const angle = i * arc;
            ctx.beginPath();
            ctx.moveTo(center, center);
            ctx.arc(center, center, radius, angle, angle + arc);
            
            // é¢œè‰²é€»è¾‘
            if (wheelEliminated.has(i)) {
                ctx.fillStyle = '#e2e8f0'; // æ·˜æ±°å˜ç°
            } else {
                ctx.fillStyle = colors[i % (colors.length - 1)];
            }
            
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 4;
            ctx.stroke();

            // æ–‡å­—ç»˜åˆ¶é€»è¾‘ (æ ¹æ®æ¨¡å¼å˜åŒ–)
            if (!wheelEliminated.has(i)) {
                ctx.save();
                ctx.translate(center, center);
                ctx.rotate(angle + arc / 2);
                ctx.textAlign = "right";
                ctx.fillStyle = "#475569";
                
                // å†³å®šæ˜¾ç¤ºçš„æ–‡å­—
                let text = "";
                if (wheelMode === 'en_cn') {
                    // è‹±è¯‘ä¸­ï¼šæ˜¾ç¤ºè‹±æ–‡
                    text = wheelData[i].word;
                } else {
                    // ä¸­è¯‘è‹±ï¼šæ˜¾ç¤ºä¸­æ–‡é‡Šä¹‰
                    text = wheelData[i].meaning;
                }

                // ç®€å•çš„æˆªæ–­å¤„ç†
                if(text.length > 8) text = text.substring(0,7) + "..";
                
                ctx.fillText(text, radius - 30, 0);
                ctx.restore();
            }
        }
    }

    window.spinWheel = function() {
        if(isSpinning) return;
        if (wheelEliminated.size >= wheelData.length) {
            alert("æœ¬è½®å•è¯å·²å…¨éƒ¨å®Œæˆï¼Œè¯·ç‚¹å‡»â€œæ¢ä¸€æ‰¹â€ï¼");
            return;
        }

        isSpinning = true;
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('flashcard').classList.remove('show');

        // éšæœºé€‰æ‹©ä¸€ä¸ªæœªæ¶ˆé™¤çš„ç´¢å¼•
        let winningIndex;
        do {
            winningIndex = Math.floor(Math.random() * wheelData.length);
        } while (wheelEliminated.has(winningIndex));

        currentCardIndex = winningIndex;

        // æ—‹è½¬åŠ¨ç”»è®¡ç®—
        const arcDegrees = 360 / wheelData.length;
        const targetAngle = winningIndex * arcDegrees + arcDegrees / 2;
        let rotate = (270 - targetAngle);
        while (rotate > -1000) rotate -= 360; 
        rotate -= (360 * 5); // å¤šè½¬5åœˆ
        
        // å¢åŠ éšæœºåç§» (æ‰‡åŒºå†…)
        const jitter = (Math.random() - 0.5) * (arcDegrees * 0.7);
        rotate += jitter;

        const canvas = document.getElementById('wheelCanvas');
        canvas.style.transition = 'transform 3.5s cubic-bezier(0.2, 0.8, 0.3, 1)';
        canvas.style.transform = `rotate(${rotate}deg)`;

        setTimeout(() => {
            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;
            showFlashcard(wheelData[winningIndex]);
        }, 3500);
    };

    function showFlashcard(item) {
        const card = document.getElementById('flashcard');
        const qEl = document.getElementById('cardQuestion');
        const hEl = document.getElementById('cardHint');
        const aEl = document.getElementById('cardAnswer');
        
        document.querySelector('.answer-mask').classList.remove('revealed');

        if (wheelMode === 'en_cn') {
            // è‹± âœ ä¸­
            qEl.innerText = item.word;
            hEl.innerText = item.pos + " (è¯·å›å¿†ä¸­æ–‡æ„æ€)";
            aEl.innerHTML = `
                <div style="font-size:1.5rem; color:var(--primary); font-weight:bold;">${item.meaning}</div>
                <div style="margin:10px 0; border-top:1px dashed #ccc;"></div>
                <div style="font-style:italic; color:#475569;">${item.sentence}</div>
                <div style="font-size:0.9rem; color:#94a3b8;">${item.translation}</div>
            `;
            setTimeout(() => speak(item.word), 200);
        } else {
            // ä¸­ âœ è‹±
            qEl.innerText = item.meaning;
            hEl.innerText = item.pos + " (è¯·æ‹¼å†™è‹±æ–‡å•è¯)";
            aEl.innerHTML = `
                <div style="font-size:2rem; font-weight:bold; color:var(--primary);">${item.word}</div>
                <div style="color:#64748b; font-family:'Lucida Sans Unicode'">${item.phonetic}</div>
                <div style="margin:10px 0; border-top:1px dashed #ccc;"></div>
                <div style="font-style:italic; color:#475569;">${item.sentence}</div>
            `;
        }

        card.classList.add('show');
    }

    window.revealAnswer = function() {
        document.querySelector('.answer-mask').classList.add('revealed');
        if (wheelMode === 'cn_en') {
            speak(wheelData[currentCardIndex].word);
        }
    }

    window.speakCurrentCard = function() {
        if(currentCardIndex !== -1) speak(wheelData[currentCardIndex].word);
    }

    window.cardAction = function(type) {
        document.getElementById('flashcard').classList.remove('show');
        if (type === 'got') {
            wheelEliminated.add(currentCardIndex);
            updateWheelStats();
            drawWheel(); 
        }
    }

    // å¯åŠ¨
    init();

</script>
</body>
</html>
